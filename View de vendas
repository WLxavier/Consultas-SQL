CREATE OR REPLACE VIEW LABORSIL.AD_VENDAS_GERAL
AS SELECT
    PCPEDC.CODFILIAL AS FILIAL,
    PCMOV.NUMPED,
    PCMOV.DTMOV,
    CAST(REPLACE(TO_CHAR(PCMOV.DTMOV, 'Month/YYYY', 'NLS_DATE_LANGUAGE = Portuguese'), ' ', '') AS VARCHAR2(20)) AS MesAno,
    PCPEDC.POSICAO,
    PCCLIENT.CODCLI,
    PCCLIENT.CGCENT AS CNPJ,
    PCCLIENT.CLIENTE,
    PCCLIENT.EXPORTARDADOSIMS,
    PCCIDADE.NOMECIDADE AS CIDADE,
    PCCIDADE.LATITUDE,
    PCCIDADE.LONGITUDE,
    PCCIDADE.UF AS ESTADO,
    PCREDECLIENTE.DESCRICAO AS REDE,
    PCPLPAG.CODPLPAG,
    PCPLPAG.DESCRICAO AS PLPAG,
    TO_CHAR(PCPLPAG.NUMDIAS) AS PRAZO_MEDIO,
    PCMOV.CODPROD,
    PCMOV.CODAUXILIAR AS EAN,
    PCMOV.DESCRICAO,
    PCMARCA.CODMARCA,
    PCMARCA.MARCA,
    PCMOV.QT,
    CASE WHEN (PCMOV.PUNIT - PCMOV.ST) < 0 THEN 0 ELSE (PCMOV.PUNIT - PCMOV.ST) END AS PUNIT,
    CASE WHEN (PCMOV.PUNIT) < 0 THEN 0 ELSE (PCMOV.PUNIT) END AS PFINAL,
  CASE PCUSUARI.CODUSUR 
    WHEN 309 THEN 310 
    WHEN 304 THEN 305 
    WHEN 229 THEN 17
    WHEN 237 THEN 26
    ELSE PCUSUARI.CODUSUR 
  END AS CODUSUR,
  CASE PCUSUARI.NOME 
    WHEN 'RAFAEL TESCH GERAL' THEN 'RAFAEL SILVA TESCH' 
    WHEN 'RAFAEL GRIFFO GERAL' THEN 'RAFAEL GRIFFO DE OLIVEIRA' 
    WHEN 'ELSON BUSSULAR GERAL' THEN 'ELSON BUSSULAR'
    WHEN 'ATILA GERAL' THEN 'ATILA DORIAN COSTA MUNIZ'
    ELSE PCUSUARI.NOME 
  END AS RCA,
    PCSUPERV.CODSUPERVISOR,
    PCSUPERV.NOME AS SUPERVISOR,
    CASE PCEMPR.NOME
        WHEN 'ALTALICE DA MACENA ZANONE' THEN 'ALTALICE' 
        WHEN 'ALINE PEREIRA DE ATAYDE INTRA' THEN 'ALINE' 
        WHEN 'PATRICK SILVA BRAGANÇA MARTINS' THEN 'PATRICK'
        WHEN 'PAULA ROBERTA MAGALHÃES RODRIGUES' THEN 'PAULA'
        WHEN 'DANIELA COELHO DA SILVA' THEN 'DANIELA'
        WHEN 'SHISLEY COSTA FERREIRA PESSOA' THEN 'SHISLEY'
        WHEN 'JULIA GRACIELLE TRABACH' THEN 'JULIA'
        WHEN 'GABRIELLA TONINI PEREIRA PAIVA' THEN 'GABRIELLA'
        ELSE PCEMPR.NOME
	END AS EMITENTE,
    PCMOV.NUMNOTA,
    CASE WHEN PCPEDC.TIPOFV IS NOT NULL THEN PCPEDC.TIPOFV ELSE PCPEDC.LOG4 END AS TIPOFV,
	TO_CHAR(CASE WHEN PCPLPAG.CODPLPAG IN (63,207,209) THEN 'BONIFICAÇÃO' ELSE 'FATURADO' END) AS TIPO_PEDIDO,
	CASE 
		WHEN PCPLPAG.CODPLPAG IN (63,207,209) THEN 0 
		ELSE (CASE WHEN (PCMOV.QT * (PCMOV.PUNIT - PCMOV.ST)) < 0 THEN 0 ELSE (PCMOV.QT * (PCMOV.PUNIT - PCMOV.ST)) END) END AS VLTOTAL,
    CASE WHEN PCMARCA.CODMARCA IN (1883, 1898, 1872, 1827, 1899, 1911, 1897) THEN 'SIM' ELSE 'NÃO' END ETICO,
    PCEMPR.CODSETOR,
    TO_CHAR('VENDA') AS MOTIVO_DEV
  FROM
    PCPEDC,
    PCMOV,
    PCCLIENT,
    PCPLPAG,
    PCEMPR,
    PCUSUARI,
    PCMARCA,
    PCPRODUT,
    PCREDECLIENTE,
    PCSUPERV,
    PCCIDADE
  WHERE
    PCCLIENT.CODCLI = PCMOV.CODCLI
    AND PCCLIENT.CODCLI = PCPEDC.CODCLI
    AND PCMOV.NUMPED = PCPEDC.NUMPED
    AND PCPEDC.CODPLPAG = PCPLPAG.CODPLPAG
    AND PCUSUARI.CODUSUR = PCMOV.CODUSUR
    AND PCEMPR.MATRICULA = PCPEDC.CODEMITENTE
    AND PCUSUARI.CODSUPERVISOR = PCSUPERV.CODSUPERVISOR(+)
    AND PCCIDADE.CODCIDADE = PCCLIENT.CODCIDADE
    AND PCMARCA.CODMARCA = PCPRODUT.CODMARCA
    AND PCPRODUT.CODPROD = PCMOV.CODPROD
    AND PCCLIENT.CODREDE = PCREDECLIENTE.CODREDE
    AND PCMOV.NUMTRANSVENDA IN (SELECT PCNFSAID.NUMTRANSVENDA 
                                FROM PCNFSAID 
                                WHERE PCNFSAID.DTCANCEL IS NULL)
    AND PCMOV.DTCANCEL IS NULL
    AND PCCLIENT.CODCLI NOT IN (2225)
  GROUP BY 
    PCPEDC.CODFILIAL,
    PCPEDC.POSICAO,
    PCMOV.NUMPED,
    PCMOV.DTMOV,
    PCCLIENT.CODCLI,
    PCCLIENT.CGCENT,
    PCPLPAG.CODPLPAG,
    PCCIDADE.NOMECIDADE,
    PCCIDADE.LATITUDE,
    PCCIDADE.LONGITUDE,
    PCCIDADE.UF,
    PCCLIENT.CLIENTE,
    PCCLIENT.EXPORTARDADOSIMS,
    PCCLIENT.MUNICENT,
    PCSUPERV.CODSUPERVISOR,
    PCUSUARI.CODUSUR,
    PCREDECLIENTE.DESCRICAO,
    PCPLPAG.DESCRICAO,
    PCPLPAG.NUMDIAS,
    PCMOV.CODPROD,
    PCMOV.CODAUXILIAR,
    PCMOV.DESCRICAO,
    PCMOV.CODPLPAG,
    PCMARCA.CODMARCA,
    PCMARCA.MARCA,
    PCMOV.QT,
    (PCMOV.PUNIT - PCMOV.ST),
    PCMOV.PUNIT,
    PCUSUARI.NOME,
    PCSUPERV.NOME,
	PCEMPR.NOME,
    PCMOV.NUMNOTA,
    PCPEDC.TIPOFV,
    PCPEDC.LOG4,
    PCEMPR.CODSETOR,
    CASE WHEN PCMARCA.CODMARCA IN (1883, 1898, 1872, 1827, 1899, 1911, 1897) THEN 'SIM' ELSE 'NÃO' END
	
  UNION ALL

	--CONSULTA 02 - ESSA PARTE ME RETORNA AS DEVILUÇÕES(TANTO TOTAIS QUANTO AVULSA)
  SELECT
    PCMOV.CODFILIAL AS FILIAL,
    PCMOV.NUMPED,
    PCMOV.DTMOV,
    CAST(REPLACE(TO_CHAR(PCMOV.DTMOV, 'Month/YYYY', 'NLS_DATE_LANGUAGE = Portuguese'), ' ', '') AS VARCHAR2(20)) AS MesAno,
    'DV',
    PCCLIENT.CODCLI,
    PCCLIENT.CGCENT AS CNPJ,
    PCCLIENT.CLIENTE,
    PCCLIENT.EXPORTARDADOSIMS,
    PCCIDADE.NOMECIDADE AS CIDADE,
    PCCIDADE.LATITUDE,
    PCCIDADE.LONGITUDE,
    PCCIDADE.UF AS ESTADO,
    PCREDECLIENTE.DESCRICAO AS REDE,
    COALESCE(PCMOV.CODPLPAG,0),
    'DEV_CLIENTE',
    'DEV_CLIENTE',
    PCMOV.CODPROD,
    PCMOV.CODAUXILIAR AS EAN,
    PCMOV.DESCRICAO,
    PCMARCA.CODMARCA,
    PCMARCA.MARCA,
    (PCMOV.QT * -1) AS QT,
    (CASE WHEN (PCMOV.PUNIT - PCMOV.ST) < 0 THEN 0 ELSE (PCMOV.PUNIT - PCMOV.ST) END) * -1 AS PUNIT,
    (CASE WHEN (PCMOV.PUNIT) < 0 THEN 0 ELSE (PCMOV.PUNIT) END) * -1 AS PFINAL,
    CASE PCUSUARI.CODUSUR 
    WHEN 309 THEN 310 
    WHEN 304 THEN 305 
    WHEN 229 THEN 17
    WHEN 237 THEN 26
    ELSE PCUSUARI.CODUSUR 
  END AS CODUSUR,
  CASE PCUSUARI.NOME 
    WHEN 'RAFAEL TESCH GERAL' THEN 'RAFAEL SILVA TESCH' 
    WHEN 'RAFAEL GRIFFO GERAL' THEN 'RAFAEL GRIFFO DE OLIVEIRA' 
    WHEN 'ELSON BUSSULAR GERAL' THEN 'ELSON BUSSULAR'
    WHEN 'ATILA GERAL' THEN 'ATILA DORIAN COSTA MUNIZ'
    ELSE PCUSUARI.NOME 
  END AS RCA,
    PCSUPERV.CODSUPERVISOR,
    PCSUPERV.NOME AS SUPERVISOR,
    CASE PCEMPR.NOME
        WHEN 'ALTALICE DA MACENA ZANONE' THEN 'ALTALICE' 
        WHEN 'ALINE PEREIRA DE ATAYDE INTRA' THEN 'ALINE' 
        WHEN 'PATRICK SILVA BRAGANÇA MARTINS' THEN 'PATRICK'
        WHEN 'PAULA ROBERTA MAGALHÃES RODRIGUES' THEN 'PAULA'
        WHEN 'DANIELA COELHO DA SILVA' THEN 'DANIELA'
        WHEN 'SHISLEY COSTA FERREIRA PESSOA' THEN 'SHISLEY'
        WHEN 'JULIA GRACIELLE TRABACH' THEN 'JULIA'
        WHEN 'GABRIELLA TONINI PEREIRA PAIVA' THEN 'GABRIELLA'
        ELSE PCEMPR.NOME
	END AS EMITENTE,
    PCMOV.NUMNOTA,
    'ED',
    TO_CHAR('DEVOLUCAO') AS TIPO_PEDIDO,
    (CASE WHEN (PCMOV.QT * (PCMOV.PUNIT - PCMOV.ST)) < 0 THEN 0 ELSE (PCMOV.QT * (PCMOV.PUNIT - PCMOV.ST)) END) * -1 AS VLTOTAL,
    CASE WHEN PCMARCA.CODMARCA IN (1883, 1898, 1872, 1827, 1899, 1911, 1897) THEN 'SIM' ELSE 'NÃO' END ETICO,
    PCEMPR.CODSETOR,
    PCTABDEV.MOTIVO AS MOTIVO_DEV
  FROM
    PCMOV,
    PCCLIENT,
    PCEMPR,
    PCUSUARI,
    PCMARCA,
    PCPRODUT,
    PCREDECLIENTE,
    PCSUPERV,
    PCCIDADE,
    PCTABDEV
  WHERE
    PCCLIENT.CODCLI = PCMOV.CODCLI
    AND PCUSUARI.CODUSUR = PCMOV.CODUSUR
    AND PCUSUARI.CODSUPERVISOR = PCSUPERV.CODSUPERVISOR
    AND PCMOV.CODFUNCLANC = PCEMPR.MATRICULA
    AND PCMARCA.CODMARCA = PCPRODUT.CODMARCA
    AND PCPRODUT.CODPROD = PCMOV.CODPROD
    AND PCREDECLIENTE.CODREDE = PCCLIENT.CODREDE
    AND PCCIDADE.CODCIDADE = PCCLIENT.CODCIDADE
    AND PCTABDEV.CODDEVOL = PCMOV.CODDEVOL
    AND PCMOV.CODOPER = 'ED'
    AND PCMOV.DTCANCEL IS NULL
    AND PCCLIENT.CODCLI NOT IN (2225)
  GROUP BY
    PCMOV.NUMPED,
    PCMOV.DTMOV,
    PCCLIENT.CODCLI,
    PCCLIENT.CGCENT,
    PCCLIENT.CLIENTE,
    PCCLIENT.MUNICENT,
    PCUSUARI.CODUSUR,
    PCREDECLIENTE.DESCRICAO,
    PCMOV.CODPROD,
    PCMOV.CODAUXILIAR,
    PCMOV.DESCRICAO,
    PCMOV.CODPLPAG,
    PCMARCA.CODMARCA,
    PCMARCA.MARCA,
    PCCLIENT.EXPORTARDADOSIMS,
    PCMOV.QT,
    PCSUPERV.CODSUPERVISOR,
    (PCMOV.PUNIT - PCMOV.ST),
    PCMOV.PUNIT,
    PCUSUARI.NOME,
    PCSUPERV.NOME,
    PCCIDADE.NOMECIDADE,
    PCCIDADE.LATITUDE,
    PCCIDADE.LONGITUDE,
    PCCIDADE.UF,
    PCEMPR.NOME,
    PCMOV.NUMNOTA,
    PCTABDEV.MOTIVO,
    PCEMPR.CODSETOR,
    PCMOV.CODFILIAL,
    CASE WHEN PCMARCA.CODMARCA IN (1883, 1898, 1872, 1827, 1899, 1911, 1897) THEN 'SIM' ELSE 'NÃO' END
    
    UNION ALL
    
    --CONSULTA 03 - ESSA PARTE ME RETORNA OS PEDIDOS QUE VÃO SER FATURADOS AINDA
   SELECT
	P.CODFILIAL AS FILIAL,
	P.NUMPED,
	COALESCE(TRUNC(P.DTFAT), TRUNC(SYSDATE)) AS DTMOV,
	  CAST(REPLACE(TO_CHAR(COALESCE(TRUNC(P.DTFAT), TRUNC(SYSDATE)), 'Month/YYYY', 'NLS_DATE_LANGUAGE = Portuguese'), ' ', '') AS VARCHAR2(20)) AS MesAno,
	P.POSICAO,
	C.CODCLI,
	C.CGCENT AS CNPJ,
	C.CLIENTE,
	C.EXPORTARDADOSIMS,
	CID.NOMECIDADE AS CIDADE,
	CID.LATITUDE,
	CID.LONGITUDE,
	CID.UF AS ESTADO,
	REDE.DESCRICAO AS REDE,
	PL.CODPLPAG,
	PL.DESCRICAO AS PLPAG,
	TO_CHAR(PL.NUMDIAS) AS PRAZO_MEDIO,
	PROD.CODPROD,
	PROD.CODAUXILIAR AS EAN,
	PROD.DESCRICAO,
	M.CODMARCA,
	M.MARCA,
	QT,
	ROUND(CASE WHEN I.PVENDA < I.ST THEN 0 ELSE I.PVENDA - I.ST END,2) AS PUNIT,
	ROUND(CASE WHEN I.PVENDA < 0 THEN 0 ELSE I.PVENDA END,2) AS PFINAL,
	CASE U.CODUSUR 
    WHEN 309 THEN 310 
    WHEN 304 THEN 305 
    WHEN 229 THEN 17
    WHEN 237 THEN 26
    ELSE U.CODUSUR 
  END AS CODUSUR,
  CASE U.NOME 
    WHEN 'RAFAEL TESCH GERAL' THEN 'RAFAEL SILVA TESCH' 
    WHEN 'RAFAEL GRIFFO GERAL' THEN 'RAFAEL GRIFFO DE OLIVEIRA' 
    WHEN 'ELSON BUSSULAR GERAL' THEN 'ELSON BUSSULAR'
    WHEN 'ATILA GERAL' THEN 'ATILA DORIAN COSTA MUNIZ'
    ELSE U.NOME 
  END AS RCA,
	S.CODSUPERVISOR,
	S.NOME AS SUPERVISOR,
    CASE PCEMPR.NOME
        WHEN 'ALTALICE DA MACENA ZANONE' THEN 'ALTALICE' 
        WHEN 'ALINE PEREIRA DE ATAYDE INTRA' THEN 'ALINE' 
        WHEN 'PATRICK SILVA BRAGANÇA MARTINS' THEN 'PATRICK'
        WHEN 'PAULA ROBERTA MAGALHÃES RODRIGUES' THEN 'PAULA'
        WHEN 'DANIELA COELHO DA SILVA' THEN 'DANIELA'
        WHEN 'SHISLEY COSTA FERREIRA PESSOA' THEN 'SHISLEY'
        WHEN 'JULIA GRACIELLE TRABACH' THEN 'JULIA'
        WHEN 'GABRIELLA TONINI PEREIRA PAIVA' THEN 'GABRIELLA'
        ELSE PCEMPR.NOME
	END AS EMITENTE,
	P.NUMNOTA,
	 CASE WHEN P.TIPOFV IS NOT NULL THEN P.TIPOFV ELSE P.LOG4 END AS TIPOFV,
	TO_CHAR(CASE WHEN PL.CODPLPAG IN (63,207,209) THEN 'A BONIFICAR' ELSE 'A FATURAR' END) AS TIPO_PEDIDO,
	(CASE WHEN PL.CODPLPAG IN (63,207,209) THEN 0 ELSE ROUND(CASE WHEN (I.QT * (I.PVENDA - I.ST)) < 0 THEN 0 ELSE (I.QT * (I.PVENDA - I.ST)) END,2) END) AS VLTOTAL,
	CASE WHEN M.CODMARCA IN (1883, 1898, 1872, 1827, 1899, 1911, 1897) THEN 'SIM' ELSE 'NAO' END AS ETICO,
	PCEMPR.CODSETOR AS CODSETOR,
	TO_CHAR('VENDA') AS MOTIVO_DEV
	FROM PCPEDC P
	JOIN PCPEDI I ON I.NUMPED = P.NUMPED
	JOIN PCCLIENT C ON C.CODCLI = P.CODCLI
	JOIN PCCIDADE CID ON CID.CODCIDADE = C.CODCIDADE
	JOIN PCREDECLIENTE REDE ON REDE.CODREDE = C.CODREDE
	JOIN PCPLPAG PL ON P.CODPLPAG = PL.CODPLPAG
	JOIN PCPRODUT PROD ON PROD.CODPROD = I.CODPROD
	JOIN PCREGIAO ON PCREGIAO.NUMREGIAO = P.NUMREGIAO
	JOIN PCMARCA M ON M.CODMARCA = PROD.CODMARCA
	JOIN PCEMPR ON PCEMPR.MATRICULA = p.CODEMITENTE
	JOIN PCUSUARI U ON U.CODUSUR = I.CODUSUR
	JOIN PCSUPERV S ON S.CODSUPERVISOR = U.CODSUPERVISOR
WHERE P.POSICAO <> 'F'
AND P.POSICAO <> 'C'
AND C.CODCLI NOT IN (2225)
